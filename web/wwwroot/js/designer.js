!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);let s={remove:function(t,e){let i=!1;if(e&&e instanceof Array)for(let s=0,n=e.length;s<n;s++)e[s]===t&&(e.splice(s,1),i=!0);return i}},n={forEachOwnProperty:function(t,e){for(let i in t)t.hasOwnProperty(i)&&e(i,t[i])}},r={distance:function(t,e){let i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},arePointsColinear:function(t,e,i,s){return s=void 0===s?.01:s,Math.abs(t.x*(e.y-i.y)+e.x*(i.y-t.y)+i.x*(t.y-e.y))<=s},arePointsEqual:function(t,e){return t.x===e.x&&t.y===e.y},isPointCloseToSegment:function(t,e,i,s){s=void 0===s?.01:s;let n=i.x,r=i.y,o=e.x-t.x,a=e.y-t.y,h={};if(0===o&&0===a)h=t;else{let i=((n-t.x)*o+(r-t.y)*a)/(o*o+a*a);h.x=t.x+i*(e.x-t.x),h.y=t.y+i*(e.y-t.y)}return!!this.isPointOnSegment(t,e,h)&&(o=n-h.x,a=r-h.y,Math.sqrt(o*o+a*a)<=s)},isPointOnSegment:function(t,e,i){let s=Math.min(t.x,e.x),n=Math.max(t.x,e.x),r=Math.min(t.y,e.y),o=Math.max(t.y,e.y);return i.x>=s&&i.x<=n&&i.y>=r&&i.y<=o},getNormalVector:function(t,e,i){if(this.arePointsEqual(t,e))throw new Error("Cannot create normal vector from equal points");let s=e.x-t.x,n=e.y-t.y,r=this.distance(t,e);return i?{x:-n/r,y:s/r}:{x:n/r,y:-s/r}},getVector:function(t,e){if(this.arePointsEqual(t,e))throw new Error("Cannot create vector from equal points");let i={};return i.x=e.x-t.x,i.y=e.y-t.y,i},getUnitVector:function(t,e){let i=this.getVector(t,e),s=Math.sqrt(i.x*i.x+i.y*i.y);return i.x=i.x/s,i.y=i.y/s,i},translateVector:function(t,e){return{x:t.x+e.x,y:t.y+e.y}},vecByScalMul:function(t,e){return{x:t.x*e,y:t.y*e}},isPointInCircle:function(t,e,i){let s=Math.abs(e.x-t.x);if(s>i)return!1;let n=Math.abs(e.y-t.y);return!(n>i)&&(s+n<=i||s*s+n*n<=i*i)},getPointOnCircleGivenAngle:function(t,e,i){return{x:t.x+e*Math.cos(i),y:t.y+e*Math.sin(i)}},centerOfCircleFrom3Points:function(t,e,i){let s=t.x-i.x,n=t.y-i.y,r=e.x-i.x,o=e.y-i.y,a=2*(s*o-r*n),h=s*s+n*n,_=r*r+o*o,d={};return d.x=(o*h-n*_)/a+i.x,d.y=(s*_-r*h)/a+i.y,d},getMidAngleOfArc:function(t,e,i){let s=(t+e)/2;return t<=e&&i||t>e&&!i?s<=0?s+Math.PI:s-Math.PI:s}};class o{constructor(t,e,i){this._name=t,this._methods=e||[],this._properties=i||[];for(let t=0,i=e.length;t<i;t++){if("string"!=typeof e[t])throw new Error("To define an interface you need to provide list of method names of type string");this._methods.push(e[t])}for(let t=0,e=i.length;t<e;t++){if("string"!=typeof i[t])throw new Error("To define an interface you need to provide list of property names of type string");this._properties.push(i[t])}}isImplemtedBy(t){if("object"!=typeof t)throw new Error("The "+this._name+" interface is not implemented by "+typeof t);for(let e=0,i=this._methods.length;e<i;e++){let i=this._methods[e];if(void 0===t[i]||"function"!=typeof t[i])throw new Error("Object does not implement the interface "+this._name+". Missing method: "+i)}for(let e=0,i=this._properties.length;e<i;e++){let i=this._properties[e];if(void 0===t[i]||"function"==typeof t[i])throw new Error("Object does not implement the interface "+this._name+". Missing properties: "+i)}}}class a{constructor(){this._listeners=[]}registerListener(t){if(!t||"function"!=typeof t)throw new Error("Event listener has to be of type function");this._listeners.push(t)}unregisterListener(t){return s.remove(t,this._listeners)}clear(){this._listeners=[]}invoke(t){const e=this._listeners;for(let i=0,s=e.length;i<s;i++)e[i](t)}}class h{constructor(){this.EVENT_REGISTERED_EVENT="event-registered",this.EVENT_UNREGISTERED_EVENT="event-unregistered",this._events=new Map,this._events.set(this.EVENT_REGISTERED_EVENT,new a),this._events.set(this.EVENT_UNREGISTERED_EVENT,new a)}create(t){this._events.has(t)||(this._events.set(t,new a),this.raise(this.EVENT_REGISTERED_EVENT,t))}delete(t){let e=!1,i=this._events;return i.has(t)&&(i.delete(t),this.raise(this.EVENT_UNREGISTERED_EVENT,t),e=!0),e}raise(t,e){let i=!1,s=this._events.get(t);return s&&(s.invoke(e),i=!0),i}registerListener(t,e){let i=!1,s=this._events.get(t);return s&&(s.registerListener(e),i=!0),i}unregisterListener(t,e){let i=!1,s=this._events.get(t);return s&&(i=s.unregisterListener(e)),i}}class _{constructor(){this._receivers=new Map}register(t,e){let i=this._receivers;if(i.has(t))throw new Error("Receiver "+t+" already registered");if(!e||"function"!=typeof e)throw new Error("Receiver must be a function");i.set(t,e)}unregister(t){let e=!1,i=this._receivers;return i.has(t)&&(i.delete(t),e=!0),e}send(t,e){let i=this._receivers;if(!i.has(t))throw new Error("Receiver "+t+" not registered");return i.get(t)(e)}}class d{constructor(){this._modules=new Map}add(t,e){this._modules.set(e,t)}init(t){let e=!1,i=this._modules.get(t);return i&&(i.isInit||i.init(),e=!0),e}initAll(){for(let t of this._modules.values())t.isInit||t.init()}start(t){let e=!1,i=this._modules.get(t);return i&&(i.isRunning||i.start(),e=!0),e}stop(t){let e=!1,i=this._modules.get(t);return i&&(i.isRunning&&i.stop(),e=!0),e}remove(t){let e=!1,i=this._modules;return i.has(t)&&(this.stop(t),i.get(t).cleanUp(),i.delete(t),e=!0),e}}class l{constructor(){this._interfaces=new Map}declare(t,e,i){this._interfaces.set(t,new o(t,e,i))}assert(t,e){const i=this._interfaces.get(e);if(!i)throw new Error("Interface "+e+" is not declared");i.isImplemtedBy(t)}}class E{constructor(t){this._core=t}registerMessageReceiver(t,e){this._core.registerMessageReceiver(t,e)}unregisterMessageReceiver(t){return this._core.unregisterMessageReceiver(t)}sendMessage(t,e){return this._core.sendMessage(t,e)}createEvent(t){this._core.createEvent(t)}deleteEvent(t){return this._core.deleteEvent(t)}raiseEvent(t,e){return this._core.raiseEvent(t,e)}registerListener(t,e){this._core.registerListener(t,e)}unregisterListener(t,e){return this._core.unregisterListener(t,e)}declareInterface(t,e,i){this._core.declareInterface(t,e,i)}assertInterface(t,e){this._core.assertInterface(t,e)}}class c{constructor(){this.APP_INIT_EVENT="app-init",this.MODULE_INTERFACE="module",this._isInit=!1,this._sandbox=new E(this),this._mediator=new _,this._modulesManager=new d,this._eventsManager=new h,this._interfacesManager=new l,this.createEvent(this.APP_INIT_EVENT),this.declareInterface(this.MODULE_INTERFACE,["init","start","stop","cleanUp"],["isInit","isRunning"])}init(){return this._isInit||(this._modulesManager.initAll(),this._isInit=!0,this.raiseEvent(this.APP_INIT_EVENT)),null}addModule(t,e,i){if(this._isInit)throw new Error("Cannot add modules when the app is initialised");const s=new t(this._sandbox,i);this.assertInterface(s,this.MODULE_INTERFACE),this._modulesManager.add(s,e)}startModule(t){return this._modulesManager.start(t)}stopModule(t){return this._modulesManager.stop(t)}removeModule(t){return this._modulesManager.remove(t)}registerMessageReceiver(t,e){this._mediator.register(t,e)}unregisterMessageReceiver(t){return this._mediator.unregister(t)}sendMessage(t,e){return this._mediator.send(t,e)}createEvent(t){this._eventsManager.create(t)}deleteEvent(t){return this._eventsManager.delete(t)}raiseEvent(t,e){return this._eventsManager.raise(t,e)}registerListener(t,e){this._eventsManager.registerListener(t,e)}unregisterListener(t,e){return this._eventsManager.unregisterListener(t,e)}declareInterface(t,e,i){this._interfacesManager.declare(t,e,i)}assertInterface(t,e){this._interfacesManager.assert(t,e)}}class u{constructor(t,e){this.CLEAR_CANVAS="canvas-clear",this.DRAW_ON_CANVAS="canvas-draw",this.REDRAW_CANVAS="canvas-redraw",this.CANVAS_CLEARED_EVENT="canvas-cleared",this.CANVAS_DRAWN_EVENT="canvas-drawn",this.CANVAS_RESIZED_EVENT="canvas-resized",this.APPEND_DOM_ELEMENT="append-dom-element",this.GET_APP_SIZE="get-app-size",this.MAKE_INTERACTIVE="make-interactive",this.APP_INIT_EVENT="app-init",this.APP_RESIZED_EVENT="app-resized",this.isInit=!1,this.isRunning=!1,this._isInteractive=!(!e||void 0===e.isInteractive)&&e.isInteractive,this._size=e.size||{width:"auto",height:"auto"},this._minSize=e.minSize||{width:0,height:0},this._sandbox=t,this._canvas,this._context,this._sandbox.createEvent(this.CANVAS_CLEARED_EVENT),this._sandbox.createEvent(this.CANVAS_DRAWN_EVENT),this._sandbox.createEvent(this.CANVAS_RESIZED_EVENT)}init(){this.isInit||(this._sandbox.registerListener(this.APP_INIT_EVENT,this.onAppInit.bind(this)),this.isInit=!0,this.start())}start(){this.isRunning||(this._sandbox.registerMessageReceiver(this.CLEAR_CANVAS,this.clear.bind(this)),this._sandbox.registerMessageReceiver(this.DRAW_ON_CANVAS,this.draw.bind(this)),this._sandbox.registerMessageReceiver(this.REDRAW_CANVAS,this.redraw.bind(this)),this.isRunning=!0)}onAppInit(){let t=this._size.width,e=this._size.height;if("auto"===this._size.width||"auto"===this._size.height){let i=this._sandbox.sendMessage(this.GET_APP_SIZE);t="auto"===this._size.width?Math.max(i.width,this._minSize.width):this._size.width,e="auto"===this._size.height?Math.max(i.height,this._minSize.height):this._size.height,this._sandbox.registerListener(this.APP_RESIZED_EVENT,this._onAppResized.bind(this))}this._canvas=this._sandbox.sendMessage(this.APPEND_DOM_ELEMENT,{type:"canvas",width:t,height:e}),this._context=this._canvas.getContext("2d",{alpha:!1}),this._isInteractive&&this._sandbox.sendMessage(this.MAKE_INTERACTIVE,this._canvas),this.clear()}clear(){this._context.save(),this._context.fillStyle="#FFFFFF",this._context.fillRect(0,0,this._canvas.width,this._canvas.height),this._context.restore(),this._sandbox.raiseEvent(this.CANVAS_CLEARED_EVENT,this._canvas)}draw(t){if(t instanceof Array)for(let e=0,i=t.length;e<i;e++)t[e].draw(this._context);else t.draw(this._context);this._sandbox.raiseEvent(this.CANVAS_DRAWN_EVENT,{canvas:this._canvas,drawables:t})}redraw(t){this.clear(),this.draw(t)}resize(t){this._canvas.width=t.width,this._canvas.height=t.height,this.clear(),this._sandbox.raiseEvent(this.CANVAS_RESIZED_EVENT,t)}stop(){this.isRunning&&(this.isRunning=!1,this._sandbox.unregisterMessageReceiver(this.CLEAR_CANVAS),this._sandbox.unregisterMessageReceiver(this.DRAW_ON_CANVAS),this._sandbox.unregisterMessageReceiver(this.REDRAW_CANVAS))}cleanUp(){this._sandbox.deleteEvent(this.CANVAS_CLEARED_EVENT),this._sandbox.deleteEvent(this.CANVAS_DRAWN_EVENT)}_onAppResized(t){this.resize({width:"auto"===this._size.width?Math.max(t.width,this._minSize.width):this._size.width,height:"auto"===this._size.height?Math.max(t.height,this._minSize.height):this._size.height})}}class g{constructor(t,e){if(this.APPEND_DOM_ELEMENT="append-dom-element",this.GET_ELEMENTS_BY_TAG="get-element-by-tag",this.GET_APP_SIZE="get-app-size",this.SHOW_POPUP="popup-show",this.HIDE_POPUP="popup-hide",this.APP_RESIZED_EVENT="app-resized",this.APP_INIT_EVENT="app-init",this.KEY_DOWN_EVENT="key-down",!e||!e.entrypoint)throw new Error("DomManager requires configuration object with an entrypoint defined");this._windowResizedBind=this._onWindowResized.bind(this),this.isInit=!1,this.isRunning=!1,this._sandbox=t,this._outerDiv=document.getElementById(e.entrypoint),this._popup=this._createPopupContainer(),this._sandbox.createEvent(this.APP_RESIZED_EVENT)}init(){this.isInit||(this._sandbox.registerListener(this.APP_INIT_EVENT,this.onAppInit.bind(this)),this.isInit=!0,this.start())}start(){this.isRunning||(this._sandbox.registerListener(this.KEY_DOWN_EVENT,this._onKeyPressed.bind(this)),this._sandbox.registerMessageReceiver(this.APPEND_DOM_ELEMENT,this.appendDomElement.bind(this)),this._sandbox.registerMessageReceiver(this.GET_ELEMENTS_BY_TAG,this.getElementsByTag),this._sandbox.registerMessageReceiver(this.GET_APP_SIZE,this.getAppSize.bind(this)),this._sandbox.registerMessageReceiver(this.SHOW_POPUP,this.showPopup.bind(this)),this._sandbox.registerMessageReceiver(this.HIDE_POPUP,this.hidePopup.bind(this)),window.addEventListener("resize",this._windowResizedBind))}onAppInit(){}appendDomElement(t){if(!t||!t.type)throw new Error("You need to provide configuration for the DOM element to append");let e=document.createElement(t.type);return t.type=null,t.style&&(n.forEachOwnProperty(t.style,(t,i)=>{e.style[t]=i}),t.style=null),t.rawContent?t.rawContent=null:t.domContent&&(t.domContent=null),n.forEachOwnProperty(t,(t,i)=>{null!==e.hasAttribute(t)&&null!==i&&e.setAttribute(t,i)}),this._outerDiv.appendChild(e),e}getElementsByTag(t){return Array.prototype.slice.call(document.getElementsByTagName(t))}getAppSize(){let t=this._outerDiv.getBoundingClientRect();return{width:t.width,height:t.height}}showPopup(t){this._popup.container.style.display="flex",(t=t||{}).message&&(this._popup.text.innerText=t.message),t.input&&t.input.forEach(t=>{let e=document.createElement("label");e.for=t.name,e.innerText=t.label,e.style.display="block",e.style["font-size"]="0.8em",this._popup.input.appendChild(e);let i=document.createElement("input");i.type="text",i.id=t.name,i.name=t.name,i.style.display="block",i.style.width="100%",i.style["margin-bottom"]="5px",i.addEventListener("input",t.onChange),this._popup.input.appendChild(i)}),t.buttons&&t.buttons.forEach(t=>{let e=document.createElement("button");e.innerText=t.text,e.style.padding="3px",e.style.display="inline-block",e.addEventListener("click",t.onClick),this._popup.buttons.appendChild(e)})}hidePopup(){let t=null;this._popup.text.innerText="";let e=Array.prototype.slice.call(this._popup.input.getElementsByTagName("input"));return e&&(t=[],e.forEach(e=>t.push({name:e.name,value:e.value}))),this.removeChildren(this._popup.input),this.removeChildren(this._popup.buttons),this._popup.container.style.display="none",t}removeChildren(t){Array.prototype.slice.call(t.childNodes).forEach(t=>t.parentNode.removeChild(t))}stop(){this.isRunning&&(this.isRunning=!1,window.removeEventListener("resize",this._windowResizedBind),this._sandbox.unregisterMessageReceiver(this.APPEND_DOM_ELEMENT),this._sandbox.unregisterMessageReceiver(this.GET_ELEMENTS_BY_TAG),this._sandbox.unregisterMessageReceiver(this.GET_APP_SIZE))}cleanUp(){}_createPopupContainer(){let t=document.createElement("div");t.style["background-color"]="rgba(0,0,0,0.7)",t.style.position="fixed",t.style.top=0,t.style.right=0,t.style.bottom=0,t.style.left=0,t.style.display="none",t.style["align-items"]="center",t.style["justify-content"]="center",t.style["z-index"]=99;let e=document.createElement("div");e.style.background="#FFFFFF",e.style["max-height"]="75%",e.style["max-width"]="75%",e.style.padding="10px",e.style["border-style"]="solid",e.style["border-width"]="1px",e.style["border-color"]="#333333",t.appendChild(e);let i=document.createElement("p");i.id="message",i.style["margin-bottom"]="8px",e.appendChild(i);let s=document.createElement("div");s.id="input",s.style["margin-bottom"]="8px",e.appendChild(s);let n=document.createElement("div");return n.id="buttons",n.style["text-align"]="center",e.appendChild(n),document.body.appendChild(t),{container:t,text:i,input:s,buttons:n}}_onWindowResized(t){this._sandbox.raiseEvent(this.APP_RESIZED_EVENT,this.getAppSize())}_onKeyPressed(t){"Escape"===t.key&&this.hidePopup()}}class p{constructor(t){this.MAKE_INTERACTIVE="make-interactive",this.PREVENT_SCROLLING="prevent-scrolling",this.DOUBLE_CLICK_EVENT="double-click",this.POINTER_DOWN_EVENT="pointer-down",this.POINTER_MOVE_EVENT="pointer-move",this.POINTER_UP_EVENT="pointer-up",this.KEY_DOWN_EVENT="key-down",this.BUTTON_CLICKED_EVENT="button-clicked",this.GET_ELEMENTS_BY_TAG="get-element-by-tag",this.APP_INIT_EVENT="app-init",this.isInit=!1,this.isRunning=!1,this._isScrollingEnabled=!0,this._sandbox=t,this._keyDownBind=this._handleKeyDown.bind(this),this._sandbox.createEvent(this.DOUBLE_CLICK_EVENT),this._sandbox.createEvent(this.POINTER_DOWN_EVENT),this._sandbox.createEvent(this.POINTER_MOVE_EVENT),this._sandbox.createEvent(this.POINTER_UP_EVENT),this._sandbox.createEvent(this.KEY_DOWN_EVENT),this._sandbox.createEvent(this.BUTTON_CLICKED_EVENT)}init(){this.isInit||(this._sandbox.registerListener(this.APP_INIT_EVENT,this.onAppInit.bind(this)),this.isInit=!0,this.start())}start(){this.isRunning||(this._sandbox.registerMessageReceiver(this.MAKE_INTERACTIVE,this.makeInteractive.bind(this)),this._sandbox.registerMessageReceiver(this.PREVENT_SCROLLING,this.preventScrolling.bind(this)),document.addEventListener("keydown",this._keyDownBind),this.isRunning=!0)}onAppInit(){let t=this._sandbox.sendMessage(this.GET_ELEMENTS_BY_TAG,"button");t&&t.forEach(t=>{t.addEventListener("click",this._handleButtonClick.bind(this))})}makeInteractive(t){t.addEventListener("selectstart",(function(t){return t.preventDefault(),!1}),!1),t.addEventListener("dblclick",this._handleDoubleClick.bind(this)),t.addEventListener("mousedown",this._handleMouseDown.bind(this)),t.addEventListener("mousemove",this._handleMouseMove.bind(this)),t.addEventListener("mouseup",this._handleMouseUp.bind(this)),t.addEventListener("touchstart",this._handleTouchStart.bind(this)),t.addEventListener("touchend",this._handleTouchEnd.bind(this)),t.addEventListener("touchcancel",this._handleTouchCancel.bind(this)),t.addEventListener("touchmove",this._handleTouchMove.bind(this))}preventScrolling(t){this._isScrollingEnabled=!!t}stop(){this.isRunning&&(this.isRunning=!1,document.removeEventListener("keydown",this._keyDownBind),this._sandbox.unregisterMessageReceiver(this.MAKE_INTERACTIVE),this._sandbox.unregisterMessageReceiver(this.PREVENT_SCROLLING))}cleanUp(){this._sandbox.deleteEvent(this.DOUBLE_CLICK_EVENT),this._sandbox.deleteEvent(this.POINTER_DOWN_EVENT),this._sandbox.deleteEvent(this.POINTER_MOVE_EVENT),this._sandbox.deleteEvent(this.POINTER_UP_EVENT),this._sandbox.deleteEvent(this.KEY_DOWN_EVENT),this._sandbox.deleteEvent(this.BUTTON_CLICKED_EVENT)}_getPointInElement(t,e,i){var s=t.getBoundingClientRect();return{x:e-s.left,y:i-s.top}}_handleDoubleClick(t){var e=this._getPointInElement(t.target,t.clientX,t.clientY);this._sandbox.raiseEvent(this.DOUBLE_CLICK_EVENT,{target:t.target,x:e.x,y:e.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleMouseDown(t){var e=this._getPointInElement(t.target,t.clientX,t.clientY);this._sandbox.raiseEvent(this.POINTER_DOWN_EVENT,{target:t.target,x:e.x,y:e.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleMouseMove(t){var e=this._getPointInElement(t.target,t.clientX,t.clientY);this._sandbox.raiseEvent(this.POINTER_MOVE_EVENT,{target:t.target,x:e.x,y:e.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleMouseUp(t){var e=this._getPointInElement(t.target,t.clientX,t.clientY);this._sandbox.raiseEvent(this.POINTER_UP_EVENT,{target:t.target,x:e.x,y:e.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleTouchStart(t){let e=t.changedTouches[0];var i=this._getPointInElement(t.target,e.clientX,e.clientY);this._sandbox.raiseEvent(this.POINTER_DOWN_EVENT,{target:t.target,x:i.x,y:i.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleTouchEnd(t){let e=t.changedTouches[0];var i=this._getPointInElement(t.target,e.clientX,e.clientY);this._sandbox.raiseEvent(this.POINTER_UP_EVENT,{target:t.target,x:i.x,y:i.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleTouchCancel(t){let e=t.changedTouches[0];var i=this._getPointInElement(t.target,e.clientX,e.clientY);this._sandbox.raiseEvent(this.POINTER_UP_EVENT,{target:t.target,x:i.x,y:i.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleTouchMove(t){this._isScrollingEnabled||t.preventDefault();let e=t.changedTouches[0];var i=this._getPointInElement(t.target,e.clientX,e.clientY);this._sandbox.raiseEvent(this.POINTER_MOVE_EVENT,{target:t.target,x:i.x,y:i.y,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_handleKeyDown(t){this._sandbox.raiseEvent(this.KEY_DOWN_EVENT,{target:t.target,key:t.key})}_handleButtonClick(t){this._sandbox.raiseEvent(this.BUTTON_CLICKED_EVENT,t.target)}}class T{constructor(t){this.ADD_ITEM="workspace-add-item",this.REMOVE_ITEM="workspace-remove-item",this.MOVE_ITEM="workspace-move-item",this.BEGIN_DRAG="workspace-begin-drag",this.END_DRAG="workspace-end-drag",this.SELECT_ITEM="workspace-select-item",this.GET_SELECTED_ITEM="workspace-get-selection",this.GET_ITEM_AT="workspace-get-item",this.GET_ITEMS="workspace-get-items",this.REFRESH_WORKSPACE="workspace-refresh",this.ITEM_DRAG_STARTED_EVENT="workspace-drag-started",this.ITEM_MOVED_EVENT="workspace-item-moved",this.ITEM_DRAG_ENDED_EVENT="workspace-drag-ended",this.ITEM_PRESSED_EVENT="workspace-item-pressed",this.ITEM_DELETED_EVENT="workspace-item-deleted",this.ITEM_POINTER_OVER_CHANGED_EVENT="workspace-item-pointer-over-changed",this.ITEM_SELECTION_CHANGED_EVENT="workspace-item-selection-changed",this.CLEAR_CANVAS="canvas-clear",this.DRAW_ON_CANVAS="canvas-draw",this.REDRAW_CANVAS="canvas-redraw",this.PREVENT_SCROLLING="prevent-scrolling",this.APP_INIT_EVENT="app-init",this.CANVAS_RESIZED_EVENT="canvas-resized",this.POINTER_DOWN_EVENT="pointer-down",this.POINTER_MOVE_EVENT="pointer-move",this.POINTER_UP_EVENT="pointer-up",this.KEY_DOWN_EVENT="key-down",this.BUTTON_CLICKED_EVENT="button-clicked",this.DRAWABLE_INTERFACE="drawable-interface",this.HOVERABLE_INTERFACE="hoverable-interface",this.MOVABLE_INTERFACE="movable-interface",this.SELECTABLE_INTERFACE="selectable-interface",this.isInit=!1,this.isRunning=!1,this._sandbox=t,this._draggedItem=null,this._hoveredItem=null,this._selectedItem=null,this._items=[],this._sandbox.createEvent(this.ITEM_DRAG_STARTED_EVENT),this._sandbox.createEvent(this.ITEM_MOVED_EVENT),this._sandbox.createEvent(this.ITEM_DRAG_ENDED_EVENT),this._sandbox.createEvent(this.ITEM_PRESSED_EVENT),this._sandbox.createEvent(this.ITEM_DELETED_EVENT),this._sandbox.createEvent(this.ITEM_POINTER_OVER_CHANGED_EVENT),this._sandbox.createEvent(this.ITEM_SELECTION_CHANGED_EVENT),this._sandbox.declareInterface(this.DRAWABLE_INTERFACE,["draw"],[]),this._sandbox.declareInterface(this.HOVERABLE_INTERFACE,["contains","pointerOver","pointerOut"],["isHoverable"]),this._sandbox.declareInterface(this.MOVABLE_INTERFACE,["move"],["isMovable"]),this._sandbox.declareInterface(this.SELECTABLE_INTERFACE,["contains","select","unselect"],["isSelectable"])}init(){this.isInit||(this._sandbox.registerListener(this.APP_INIT_EVENT,this.onAppInit.bind(this)),this.isInit=!0,this.start())}start(){this.isRunning||(this._sandbox.registerListener(this.POINTER_DOWN_EVENT,this._handlePointerDown.bind(this)),this._sandbox.registerListener(this.POINTER_MOVE_EVENT,this._handlePointerMove.bind(this)),this._sandbox.registerListener(this.POINTER_UP_EVENT,this._handlePointerUp.bind(this)),this._sandbox.registerListener(this.CANVAS_RESIZED_EVENT,this._onCanvasResized.bind(this)),this._sandbox.registerListener(this.KEY_DOWN_EVENT,this._handleKeyDown.bind(this)),this._sandbox.registerListener(this.BUTTON_CLICKED_EVENT,this._handleButtonClicked.bind(this)),this._sandbox.registerMessageReceiver(this.ADD_ITEM,this.addItem.bind(this)),this._sandbox.registerMessageReceiver(this.REMOVE_ITEM,this.removeItem.bind(this)),this._sandbox.registerMessageReceiver(this.MOVE_ITEM,this.moveItem.bind(this)),this._sandbox.registerMessageReceiver(this.SELECT_ITEM,this.selectItem.bind(this)),this._sandbox.registerMessageReceiver(this.BEGIN_DRAG,this.beginDrag.bind(this)),this._sandbox.registerMessageReceiver(this.END_DRAG,this.endDrag.bind(this)),this._sandbox.registerMessageReceiver(this.GET_ITEM_AT,this.getItemAt.bind(this)),this._sandbox.registerMessageReceiver(this.GET_SELECTED_ITEM,()=>this._selectedItem),this._sandbox.registerMessageReceiver(this.GET_ITEMS,this.getItems.bind(this)),this._sandbox.registerMessageReceiver(this.REFRESH_WORKSPACE,this.refresh.bind(this)),this.isRunning=!0)}onAppInit(){}addItem(t){this._sandbox.assertInterface(t,this.DRAWABLE_INTERFACE),t.isHoverable&&this._sandbox.assertInterface(t,this.HOVERABLE_INTERFACE),t.isMovable&&this._sandbox.assertInterface(t,this.MOVABLE_INTERFACE),t.isSelectable&&this._sandbox.assertInterface(t,this.SELECTABLE_INTERFACE),this._items.push(t),this._sandbox.sendMessage(this.DRAW_ON_CANVAS,t)}removeItem(t){for(let e=0,i=this._items.length;e<i;e++)this._items[e]===t&&this._items.splice(e,1);this._sandbox.sendMessage(this.REDRAW_CANVAS,this._items)}getItemAt(t){let e=t.point,i=this._items;for(let s=i.length-1;s>=0;s--){let n=i[s];if(n.contains&&n.contains(e)&&(!t.predicate||t.predicate(n)))return n}return null}getItems(t){return t?this._items.filter(t):this._items.slice()}beginDrag(t){let e=t.item,i=t.point;this.endDrag(i),e&&e.isMovable&&this._items.includes(e)&&e.isMovable&&(this._draggedItem=e,this._sandbox.raiseEvent(this.ITEM_DRAG_STARTED_EVENT,{item:e,point:i}),this._sandbox.sendMessage(this.PREVENT_SCROLLING,!1))}endDrag(t){if(this._draggedItem){let e=this._draggedItem;this._draggedItem=null,this._sandbox.raiseEvent(this.ITEM_DRAG_ENDED_EVENT,{item:e,point:t}),this._sandbox.sendMessage(this.PREVENT_SCROLLING,!0)}}moveItem(t){let e=t.item,i=t.point;e&&this._items.includes(e)&&e.isMovable&&(e.move(i),this._sandbox.sendMessage(this.REDRAW_CANVAS,this._items),this._sandbox.raiseEvent(this.ITEM_MOVED_EVENT,{item:e,point:i,source:t.sender}))}hoverItem(t,e){let i=this._hoveredItem,s=this._items.includes(t)&&t.isHoverable?t:null;this._hoveredItem=s;let n=!1;i&&(i.pointerOut(),n=!0),s&&(s.pointerOver(),n=!0),n&&this._sandbox.sendMessage(this.REDRAW_CANVAS,this._items),this._sandbox.raiseEvent(this.ITEM_POINTER_OVER_CHANGED_EVENT,{point:e,oldItem:i,newItem:s})}selectItem(t){let e=t.item,i=t.point,s=this._selectedItem,n=this._items.includes(e)&&e.isSelectable?e:null;this._selectedItem=n;let r=!1;s&&(s.unselect(),r=!0),n&&(n.select(i),r=!0),r&&this._sandbox.sendMessage(this.REDRAW_CANVAS,this._items),this._sandbox.raiseEvent(this.ITEM_SELECTION_CHANGED_EVENT,{point:i,oldItem:s,newItem:n})}refresh(){this._sandbox.sendMessage(this.REDRAW_CANVAS,this._items)}stop(){this.isRunning&&(this._sandbox.unregisterMessageReceiver(this.ADD_ITEM),this._sandbox.unregisterMessageReceiver(this.REMOVE_ITEM),this._sandbox.unregisterMessageReceiver(this.SELECT_ITEM),this._sandbox.unregisterMessageReceiver(this.MOVE_ITEM),this._sandbox.unregisterMessageReceiver(this.BEGIN_DRAG),this._sandbox.unregisterMessageReceiver(this.END_DRAG),this._sandbox.unregisterMessageReceiver(this.GET_ITEM_AT),this._sandbox.unregisterMessageReceiver(this.GET_SELECTED_ITEM),this._sandbox.unregisterMessageReceiver(this.GET_ITEMS),this._sandbox.unregisterMessageReceiver(this.REFRESH_WORKSPACE),this.isRunning=!1)}cleanUp(){this._sandbox.deleteEvent(this.ITEM_DRAG_STARTED_EVENT),this._sandbox.deleteEvent(this.ITEM_MOVED_EVENT),this._sandbox.deleteEvent(this.ITEM_DRAG_ENDED_EVENT),this._sandbox.deleteEvent(this.ITEM_PRESSED_EVENT),this._sandbox.deleteEvent(this.ITEM_POINTER_OVER_CHANGED_EVENT),this._sandbox.deleteEvent(this.ITEM_SELECTION_CHANGED_EVENT)}_handlePointerDown(t){let e={x:t.x,y:t.y},i=this.getItemAt({point:e});this.beginDrag({item:i,point:e}),this.selectItem({item:i,point:e})}_handlePointerMove(t){let e={x:t.x,y:t.y};if(this._draggedItem)this.moveItem({item:this._draggedItem,point:e});else{let t=this.getItemAt({point:e});(this._hoveredItem||t)&&this.hoverItem(t,e)}}_handlePointerUp(t){let e={x:t.x,y:t.y};this.endDrag(e);let i=this.getItemAt({point:e});this._selectedItem&&i===this._selectedItem&&this._sandbox.raiseEvent(this.ITEM_PRESSED_EVENT,{point:e,item:i,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey})}_deleteSelected(){let t=this._selectedItem;this.selectItem({item:null}),this.removeItem(t),this._sandbox.raiseEvent(this.ITEM_DELETED_EVENT,{item:t})}_handleKeyDown(t){"Delete"===t.key&&this._selectedItem&&this._deleteSelected()}_handleButtonClicked(t){"delete"===t.id&&this._deleteSelected()}_onCanvasResized(t){this.refresh()}}class v{constructor(t,e){this.ADD_ITEM="workspace-add-item",this.MOVE_ITEM="workspace-move-item",this.APP_INIT_EVENT="app-init",this.ITEM_MOVED_EVENT="workspace-item-moved",this.isInit=!1,this.isRunning=!1,this._sandbox=t,e=e||{},this._distance=void 0===e.distance?50:e.distance,this._reach=void 0===e.reach?5:e.reach,this._isVisible=e.visibility}init(){this.isInit||(this._sandbox.registerListener(this.APP_INIT_EVENT,this.onAppInit.bind(this)),this.isInit=!0,this.start())}start(){this.isRunning||(this._sandbox.registerListener(this.ITEM_MOVED_EVENT,this.onItemMoved.bind(this)),this.isRunning=!0)}onAppInit(){this._isVisible&&this._sandbox.sendMessage(this.ADD_ITEM,this)}draw(t){let e=t.canvas,i={name:"height",value:e.height},s={name:"width",value:e.width};if(e.width<e.height){let t=i;i=s,s=t}t.save(),t.strokeStyle="#ebebeb",t.beginPath();let n=this._distance;for(;n<i.value;n+=this._distance)t.moveTo(0,n),t.lineTo(e.width,n),t.moveTo(n,0),t.lineTo(n,e.height);for(;n<s.value;n+=this._distance)(s.name="width")?(t.moveTo(n,0),t.lineTo(n,e.height)):(t.moveTo(0,n),t.lineTo(e.width,n));t.stroke(),t.restore()}onItemMoved(t){if(t.item.isPullable){let e=this._pull(t.item.getBounds(),t.point.x,t.point.y);t.source===this||e.x===t.point.x&&e.y===t.point.y||this._sandbox.sendMessage(this.MOVE_ITEM,{item:t.item,point:e,sender:this})}}stop(){this.isRunning&&(this.isRunning=!1)}cleanUp(){}_pull(t,e,i){return{x:this._computePosition(e,t.left,t.right),y:this._computePosition(i,t.bottom,t.top)}}_computePosition(t,e,i){let s=this._nearestRuler(t,e,i);return s.distance<=this._reach?s.position:t}_nearestRuler(t,e,i){let s=e%this._distance,n=this._distance-i%this._distance,r={};return s<=n?(r.distance=s,r.position=t-s):(r.distance=n,r.position=t+n),r}}class m{constructor(t){t=t||{},this._position=t.position?Object.assign({},t.position):{x:0,y:0},this.isHoverable=!!t.isHoverable,this.isSelectable=!!t.isSelectable,this.isMovable=!!t.isMovable,this.isPullable=!!t.isPullable,this.fill=!!t.fill,this._visualState="default",this._pointerOffset=null}contains(t){return!1}draw(t){switch(t.save(),this._visualState){case"default":t.strokeStyle="#000000";break;case"hovered":t.strokeStyle="#3BA7FF";break;case"selected":t.strokeStyle="#336699";break;default:throw new Error("There is no "+this._visualState+" visual state defined.")}t.fillStyle=this.fill?t.strokeStyle:"#FFFFFF",this._decoratedDraw(t),t.restore()}getBounds(){return{left:this._position.x,top:this._position.y,right:this._position.x,bottom:this._position.y}}getPosition(){return Object.assign({},this._position)}move(t){this._position.x=t.x,this._position.y=t.y}select(t){this._visualState="selected",t&&(this._pointerOffset={x:t.x-this._position.x,y:t.y-this._position.y})}unselect(){this._visualState="default",this._pointerAnchor=null}pointerOver(){"selected"!==this._visualState&&(this._visualState="hovered")}pointerOut(){"selected"!==this._visualState&&(this._visualState="default")}_decoratedDraw(t){}}class x extends m{constructor(t){super(t=t||{}),this._text=t.text,this._font="1em sans-serif",this._offsetX=0,this._offsetY=0,this.configure(t)}configure(t){this._font=t.font||this._font,this._offsetX=void 0===t.offsetX?this._offsetX:t.offsetX,this._offsetY=void 0===t.offsetY?this._offsetY:t.offsetY}setText(t){this._text=t}_decoratedDraw(t){if(this._text){t.font=this._font;let e=t.measureText(this._text).width,i=t.measureText("O").width,s=t.fillStyle;t.fillStyle=t.strokeStyle,t.fillText(this._text,this._position.x-e*this._offsetX,this._position.y+i*this._offsetY),t.fillStyle=s}}}class I extends m{constructor(t){super(t=t||{}),this._startPoint=t.start?Object.assign({},t.start):{x:0,y:0},this._distanceToleration=void 0===t.distanceToleration?5:t.distanceToleration}getStart(){return Object.assign({},this._startPoint)}setStart(t){this._startPoint.x=t.x,this._startPoint.y=t.y}contains(t){return r.isPointCloseToSegment(this._startPoint,this._position,t,this._distanceToleration)}_decoratedDraw(t){t.beginPath(),t.moveTo(this._startPoint.x,this._startPoint.y),t.lineTo(this._position.x,this._position.y),t.stroke()}}class f extends m{constructor(t){super(t=t||{}),this._radius=void 0===t.radius?0:t.radius,this._startAngle=void 0===t.start?0:t.start,this._endAngle=void 0===t.end?0:t.end,this._reverse=void 0===t.reverse?0:t.reverse,this._distanceToleration=void 0===t.distanceToleration?5:t.distanceToleration}setStart(t){this._startAngle=t}setEnd(t){this._endAngle=t}setRadius(t){this._radius=t}setReverse(t){this._reverse=t}contains(t){if(Math.abs(r.distance(this._position,t)-this._radius)<=this._distanceToleration){let e={x:t.x-this._position.x,y:t.y-this._position.y},i=Math.atan2(e.y,e.x);if(this._startAngle<=this._endAngle){let t=this._startAngle<=i&&i<=this._endAngle;return this._reverse?!t:t}{let t=i>=this._startAngle||i<=this._endAngle;return this._reverse?!t:t}}return!1}_decoratedDraw(t){t.beginPath(),t.arc(this._position.x,this._position.y,this._radius,this._startAngle,this._endAngle,this._reverse),t.stroke()}}class y extends m{constructor(t){super(t=t||{}),this._radius=void 0===t.radius?30:t.radius}contains(t){return r.isPointInCircle(t,this._position,this._radius)}move(t){this._pointerOffset?super.move({x:t.x-this._pointerOffset.x,y:t.y-this._pointerOffset.y}):super.move(t)}getRadius(){return this._radius}getBounds(){return{left:this._position.x-this._radius,top:this._position.y+this._radius,right:this._position.x+this._radius,bottom:this._position.y-this._radius}}_decoratedDraw(t){t.beginPath(),t.arc(this._position.x,this._position.y,this._radius,0,2*Math.PI),t.fillStyle="#FFFFFF",t.fill(),t.stroke()}}class b extends m{constructor(t){super(t=t||{}),this._rotation=void 0===t.rotation?0:t.rotation,this._height=void 0===t.height?8:t.height,this._base=void 0===t.base?8:t.base,this._vertices=null,this._calculateVertices()}move(t){super.move(t),this._calculateVertices()}rotate(t){this._rotation=t,this._calculateVertices()}getBounds(){return{left:Math.min(this._vertices.top.x,this._vertices.left.x,this._vertices.right.x),top:Math.max(this._vertices.top.y,this._vertices.left.y,this._vertices.right.y),right:Math.max(this._vertices.top.x,this._vertices.left.x,this._vertices.right.x),bottom:Math.min(this._vertices.top.y,this._vertices.left.y,this._vertices.right.y)}}_calculateVertices(){let t=this._position,e={x:-Math.cos(this._rotation)*this._height+t.x,y:-Math.sin(this._rotation)*this._height+t.y},i=r.getNormalVector(e,t),s={x:-i.x,y:-i.y},n=r.translateVector(r.vecByScalMul(i,this._base/2),e),o=r.translateVector(r.vecByScalMul(s,this._base/2),e);this._vertices={top:t,left:n,right:o}}_decoratedDraw(t){t.beginPath(),t.moveTo(this._vertices.top.x,this._vertices.top.y),t.lineTo(this._vertices.left.x,this._vertices.left.y),t.lineTo(this._vertices.right.x,this._vertices.right.y),t.fill(),t.stroke()}}class M extends I{constructor(t){(t=t||{}).fill=!0,super(t),this._arrowTip=null,this._updateArrowTip()}move(t){super.move(t),this._updateArrowTip()}setStart(t){super.setStart(t),this._updateArrowTip()}_updateArrowTip(){let t=this._startPoint,e=this._position;if(r.arePointsEqual(t,e))this._arrowTip=null;else{let i=r.getVector(t,e),s=Math.atan2(i.y,i.x);this._arrowTip?(this._arrowTip.move(e),this._arrowTip.rotate(s)):this._arrowTip=new b({position:e,rotation:s})}}_decoratedDraw(t){super._decoratedDraw(t),this._arrowTip&&this._arrowTip._decoratedDraw(t)}}class A extends f{constructor(t){(t=t||{}).fill=!0,super(t),this._arrowTip=null,this._updateArrowTip()}move(t){super.move(t),this._updateArrowTip()}setStart(t){super.setStart(t),this._updateArrowTip()}setEnd(t){super.setEnd(t),this._updateArrowTip()}setRadius(t){super.setRadius(t),this._updateArrowTip()}setReverse(t){super.setReverse(t),this._updateArrowTip()}_updateArrowTip(){if(this._startAngle!==this._endAngle){let t=this._reverse?1:-1,e=r.getPointOnCircleGivenAngle(this._position,this._radius,this._endAngle),i=r.getPointOnCircleGivenAngle(this._position,this._radius,this._endAngle+10*t/this._radius),s=r.getVector(i,e),n=Math.atan2(s.y,s.x);this._arrowTip?(this._arrowTip.move(e),this._arrowTip.rotate(n)):this._arrowTip=new b({position:e,rotation:n})}else this._arrowTip=null}_decoratedDraw(t){super._decoratedDraw(t),this._arrowTip&&this._arrowTip._decoratedDraw(t)}}class N extends y{constructor(t){(t=t||{}).isHoverable=!0,t.isSelectable=!0,t.isMovable=!0,t.isPullable=!0,super(t),this.isAccepting=void 0!==t.accept&&t.accept,this.isEntry=void 0!==t.entry&&t.entry,this._textBox=new x({position:this._position,text:"PaweÅ‚",offsetX:.5,offsetY:.5}),this._entryArrow=null}accept(t){this.isAccepting=!!t}setAsEntry(t){this.isEntry=!!t}setText(t){this._textBox.setText(t)}getText(){return this._textBox._text}move(t){super.move(t),this._textBox.move(this._position)}_decoratedDraw(t){if(super._decoratedDraw(t),this._textBox._decoratedDraw(t),this.isAccepting&&(t.beginPath(),t.arc(this._position.x,this._position.y,.85*this._radius,0,2*Math.PI),t.stroke()),this.isEntry){let e=t.fillStyle,i=t.strokeStyle;t.fillStyle="#000000",t.strokeStyle="#000000",t.beginPath(),t.arc(this._position.x-2*this._radius,this._position.y,.3*this._radius,0,2*Math.PI),t.fill(),this._entryArrow?(this._entryArrow.move({x:this._position.x-this._radius,y:this._position.y}),this._entryArrow.setStart({x:this._position.x-2*this._radius,y:this._position.y})):this._entryArrow=new M({start:{x:this._position.x-2*this._radius,y:this._position.y},position:{x:this._position.x-this._radius,y:this._position.y}}),this._entryArrow._decoratedDraw(t),t.fillStyle=e,t.strokeStyle=i}}}class R extends m{constructor(t){if((t=t||{}).isHoverable=!0,t.isSelectable=!0,t.isMovable=!0,t.isPullable=!0,t.fill=!0,super(t),!t.first)throw new Error("You need to specify at least one state for the transition");this.isSet=!!t.second,this._firstItem=t.first,this._secondItem=t.second||t.first,this._sagitta=void 0===t.sagitta?0:t.sagitta,this._isReversed=!!t.reverse,this._colinearTolerance=void 0===t.tolerance?5:t.tolerance,this._selfLinkDistance=void 0===t.selfLinkSize?30:t.selfLinkSize,this._selfLinkAngle=.75,this._selfLinkDirection={x:0,y:-1},this._textBox=new x({position:this._position,text:"Aneta",offsetX:0,offsetY:0}),this._lastData=null,this._arrow=null,this._updateArrowIfNeeded()}setText(t){this._textBox.setText(t)}getText(){return this._textBox._text}isSelfLink(){return this._firstItem===this._secondItem}contains(t){return this._updateArrowIfNeeded(),this._arrow.contains(t)}move(t){if(super.move(t),this.isSelfLink())r.arePointsEqual(this._firstItem.getPosition(),this._position)||(this._selfLinkDirection=r.getUnitVector(this._firstItem.getPosition(),this._position));else if(this.isSet)if(r.arePointsColinear(this._firstItem.getPosition(),this._secondItem.getPosition(),this._position,this._colinearTolerance))this._sagitta=0;else{let t=this._firstItem.getPosition(),e=this._secondItem.getPosition(),i={x:(t.x+e.x)/2,y:(t.y+e.y)/2};if(r.arePointsEqual(t,e))this._sagitta=0;else{let s=r.centerOfCircleFrom3Points(t,e,this.getPosition()),n={x:this._position.x-t.x,y:this._position.y-t.y},o={x:this._position.x-e.x,y:this._position.y-e.y};this._isReversed=n.x*o.y-o.x*n.y>0;let a=r.getNormalVector(t,e,this._isReversed),h=r.distance(s,t),_=Math.atan2(a.y,a.x),d=r.getPointOnCircleGivenAngle(s,h,_);this._sagitta=r.distance(i,d)}}}setEndTemporarily(t){this._secondItem=t}setEnd(t){this._secondItem=t,this.isSet=!0}select(t){super.select(t),this._arrow.select(t)}unselect(){super.unselect(),this._arrow.unselect()}pointerOver(){super.pointerOver(),this._arrow.pointerOver()}pointerOut(){super.pointerOut(),this._arrow.pointerOut()}_pointsWereMoved(t,e,i){if(!this._lastData)return!0;let s=!!t&&!r.arePointsEqual(this._lastData.from,t),n=!!e&&!r.arePointsEqual(this._lastData.to,e),o=!!i&&!r.arePointsEqual(this._lastData.position,i);return s||n||o}_createSelfTransition(){let t={},e=this._firstItem.getPosition(),i=Math.atan2(this._selfLinkDirection.y,this._selfLinkDirection.x),s=r.getPointOnCircleGivenAngle(e,this._firstItem.getRadius(),i),n=r.getPointOnCircleGivenAngle(e,this._firstItem.getRadius(),i-this._selfLinkAngle/2),o=r.getPointOnCircleGivenAngle(e,this._firstItem.getRadius(),i+this._selfLinkAngle/2);t.center=r.centerOfCircleFrom3Points(n,o,r.translateVector(r.vecByScalMul(this._selfLinkDirection,this._selfLinkDistance),s)),t.radius=r.distance(t.center,n),t.startAngle=Math.atan2(n.y-t.center.y,n.x-t.center.x),t.endAngle=Math.atan2(o.y-t.center.y,o.x-t.center.x),t.reverse=!1,this._applyArrowChanges(A,t)}_createStraightTransition(){let t=this._firstItem.getPosition(),e=this._secondItem?this._secondItem.getPosition():this.getPosition();if(!r.arePointsEqual(t,e)){let i=r.translateVector(r.vecByScalMul(r.getUnitVector(t,e),this._firstItem.getRadius()),this._firstItem.getPosition());if(this._secondItem){e=r.translateVector(r.vecByScalMul(r.getUnitVector(e,t),this._secondItem.getRadius()),this._secondItem.getPosition())}t=i}this._applyArrowChanges(M,{from:t,to:e})}_createCircularTransition(){let t={},e=this._firstItem.getPosition(),i=this._secondItem.getPosition(),s={x:(e.x+i.x)/2,y:(e.y+i.y)/2};if(r.arePointsEqual(e,i))t={center:{x:0,y:0},startAngle:0,endAngle:0,radius:0};else{let n=r.getNormalVector(e,i,this._isReversed),o=r.translateVector(r.vecByScalMul(n,this._sagitta),s);t.center=r.centerOfCircleFrom3Points(e,i,o),t.radius=r.distance(t.center,e),t.reverse=this._isReversed;let a=this._isReversed?1:-1;t.startAngle=Math.atan2(e.y-t.center.y,e.x-t.center.x)-2*a*Math.asin(this._firstItem.getRadius()/(2*t.radius)),t.endAngle=Math.atan2(i.y-t.center.y,i.x-t.center.x)+2*a*Math.asin(this._secondItem.getRadius()/(2*t.radius))}this._applyArrowChanges(A,t)}_applyArrowChanges(t,e){t===M?this._arrow instanceof M?(this._arrow.setStart(e.from),this._arrow.move(e.to)):(this._arrow=new M({start:e.from,position:e.to,isMovable:!0,isSelectable:!0,isHoverable:!0,isPullable:!0}),this._arrow._visualState=this._visualState):t===A&&(this._arrow instanceof A?(this._arrow.move(e.center),this._arrow.setStart(e.startAngle),this._arrow.setEnd(e.endAngle),this._arrow.setRadius(e.radius),this._arrow.setReverse(e.reverse)):(this._arrow=new A({start:e.startAngle,end:e.endAngle,position:e.center,radius:e.radius,reverse:e.reverse,isMovable:!0,isSelectable:!0,isHoverable:!0,isPullable:!1}),this._arrow._visualState=this._visualState)),this._repositionText(t,e)}_repositionText(t,e){let i=null;t===M?i=r.translateVector(r.vecByScalMul(r.getVector(e.from,e.to),.5),e.from):t===A&&(i=r.getPointOnCircleGivenAngle(e.center,e.radius,r.getMidAngleOfArc(e.startAngle,e.endAngle,e.reverse))),this._textBox.move(i),this._textBox.configure({offsetX:null,offsetY:null})}_updateArrowIfNeeded(){let t=this._firstItem.getPosition(),e=this._secondItem?this._secondItem.getPosition():this.getPosition(),i=this.getPosition();this.isSelfLink()?this._pointsWereMoved(t,null,i)&&this._createSelfTransition():this.isSet&&0!==this._sagitta?this._pointsWereMoved(t,e,i)&&this._createCircularTransition():this._pointsWereMoved(t,e,i)&&this._createStraightTransition(),this._lastData={from:t,to:e,position:i}}_decoratedDraw(t){this._updateArrowIfNeeded(),this._arrow._decoratedDraw(t),this._textBox._decoratedDraw(t)}}class w{constructor(t){this.ADD_ITEM="workspace-add-item",this.REMOVE_ITEM="workspace-remove-item",this.BEGIN_DRAG="workspace-begin-drag",this.SELECT_ITEM="workspace-select-item",this.GET_SELECTED_ITEM="workspace-get-selection",this.GET_ITEM_AT="workspace-get-item",this.GET_ITEMS="workspace-get-items",this.REFRESH_WORKSPACE="workspace-refresh",this.SHOW_POPUP="popup-show",this.HIDE_POPUP="popup-hide",this.APP_INIT_EVENT="app-init",this.ITEM_MOVED_EVENT="workspace-item-moved",this.ITEM_PRESSED_EVENT="workspace-item-pressed",this.ITEM_DRAG_ENDED_EVENT="workspace-drag-ended",this.ITEM_DELETED_EVENT="workspace-item-deleted",this.DOUBLE_CLICK_EVENT="double-click",this.BUTTON_CLICKED_EVENT="button-clicked",this.isInit=!1,this.isRunning=!1,this._sandbox=t}init(){this.isInit||(this._sandbox.registerListener(this.APP_INIT_EVENT,this.onAppInit.bind(this)),this.isInit=!0,this.start())}start(){this.isRunning||(this._sandbox.registerListener(this.ITEM_MOVED_EVENT,this._onItemMoved.bind(this)),this._sandbox.registerListener(this.ITEM_PRESSED_EVENT,this._onItemPressed.bind(this)),this._sandbox.registerListener(this.ITEM_DRAG_ENDED_EVENT,this._onDragEnded.bind(this)),this._sandbox.registerListener(this.ITEM_DELETED_EVENT,this._onItemDeleted.bind(this)),this._sandbox.registerListener(this.DOUBLE_CLICK_EVENT,this._onPointerDoubleClicked.bind(this)),this._sandbox.registerListener(this.BUTTON_CLICKED_EVENT,this._onButtonClicked.bind(this)))}onAppInit(){}addState(t){let e=new N({position:t=t||{x:50,y:50}});this._sandbox.sendMessage(this.ADD_ITEM,e),this.changeEntryPoint({item:e,abortIfExists:!0}),this._sandbox.sendMessage(this.SELECT_ITEM,{item:e,point:t})}beginConnecting(t,e){e=e||t.getPosition();let i=new R({position:e,first:t});this._sandbox.sendMessage(this.ADD_ITEM,i),this._sandbox.sendMessage(this.BEGIN_DRAG,{item:i,point:e})}makeAccepting(t){t.accept(!t.isAccepting),this._sandbox.sendMessage(this.REFRESH_WORKSPACE)}changeEntryPoint(t){let e=this._sandbox.sendMessage(this.GET_ITEMS).find(t=>t instanceof N&&!0===t.isEntry);!t.abortIfExists&&e?(e.setAsEntry(!1),t.item.setAsEntry(!0),this._sandbox.sendMessage(this.REFRESH_WORKSPACE)):e||(t.item.setAsEntry(!0),this._sandbox.sendMessage(this.REFRESH_WORKSPACE))}stop(){this.isRunning&&(this.isRunning=!1)}cleanUp(){}_onItemPressed(t){t.item instanceof N&&(t.ctrlKey?this.beginConnecting(t.item,t.point):t.shiftKey&&this.changeEntryPoint({item:t.item}))}_onItemMoved(t){if(t.item instanceof R&&!t.item.isSet){let e=this._sandbox.sendMessage(this.GET_ITEM_AT,{point:t.point,predicate:function(t){return t instanceof N}});e?t.item.setEndTemporarily(e):t.item.setEndTemporarily(null)}}_onDragEnded(t){if(t.item instanceof R&&!t.item.isSet){let e=this._sandbox.sendMessage(this.GET_ITEM_AT,{point:t.point,predicate:function(t){return t instanceof N}});e?t.item.setEnd(e):this._sandbox.sendMessage(this.REMOVE_ITEM,t.item)}}_onItemDeleted(t){if(t.item instanceof N){if(this._sandbox.sendMessage(this.GET_ITEMS,e=>e instanceof R&&(e._firstItem===t.item||e._secondItem===t.item)).forEach(t=>{this._sandbox.sendMessage(this.REMOVE_ITEM,t)}),t.item.isEntry){let t=this._sandbox.sendMessage(this.GET_ITEMS,t=>t instanceof N);t&&t.length>0&&this.changeEntryPoint({item:t[0]})}}}_onPointerDoubleClicked(t){let e={x:t.x,y:t.y},i=this._sandbox.sendMessage(this.GET_ITEM_AT,{point:e,predicate:function(t){return t instanceof N}});i?this.makeAccepting(i):this.addState(e)}_onButtonClicked(t){let e=this._sandbox.sendMessage(this.GET_SELECTED_ITEM);switch(t.id){case"add":this.addState();break;case"connect":e&&this.beginConnecting(e);break;case"accept":e&&this.makeAccepting(e);break;case"initial":e&&this.changeEntryPoint({item:e});break;case"edit":if(e){let t=e.getText();this._sandbox.sendMessage(this.SHOW_POPUP,{message:"Please enter new name for the state",input:[{name:"state-name",label:"State name"}],buttons:[{text:"Save",onClick:t=>{let i=this._sandbox.sendMessage(this.HIDE_POPUP);e.setText(i.find(t=>"state-name"===t.name).value),this._sandbox.sendMessage(this.REFRESH_WORKSPACE)}},{text:"Cancel",onClick:i=>{this._sandbox.sendMessage(this.HIDE_POPUP),e.setText(t),this._sandbox.sendMessage(this.REFRESH_WORKSPACE)}}]})}}}}!function(t){const e=new c;e.addModule(u,"canvas",{isInteractive:!0,minSize:{width:800,height:600}}),e.addModule(g,"dom-manager",{entrypoint:"workspace"}),e.addModule(p,"interaction"),e.addModule(T,"workspace"),e.addModule(v,"ruler",{distance:15,reach:3,visibility:!0}),e.addModule(w,"fsm-designer"),e.init()}()}]);